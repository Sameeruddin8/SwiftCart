<!DOCTYPE html>
<html>
<head>
    <header>
        <h2 style="font-size:36px; padding:10px;">Smart cart</h2>
        <nav>
            <ul>
                <li><a href="#">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact </a></li>
            </ul>
        </nav>
    </header>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles2.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="cardi">
        <h1>Webcam Capture</h1>
        <div id="video-container">
            <video id="video" autoplay></video>
        </div>
        <button id="capture-button">Add to Cart</button>
    </div>

    <h3>Selected Items</h3>
    <div id="result">
        <!-- Recognition results will be displayed here -->
    </div>

    <div id="cart">
        <!-- Cart section to display items added to the cart -->
        <h3>Shopping Cart</h3>
        <ul id="cart-items">
            <!-- Cart items will be dynamically added here -->
        </ul>
        <div id="cart-total">
            <!-- Display total amount here -->
        </div>
        <button class="navigate" onclick="navigateToPayment()">Proceed to Payment</button>
    </div>

    <script>
        // JavaScript for capturing image from webcam
        const video = document.getElementById('video');
        const captureButton = document.getElementById('capture-button');

        // Function to start the webcam
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
            } catch (error) {
                console.error('Error accessing webcam:', error);
            }
        }

        // Start webcam when the page loads
        startWebcam();

        // Event listener for capture button click
        captureButton.addEventListener('click', captureAndUploadImage);

        // Function to capture image from webcam and send it to Flask
        function captureAndUploadImage() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            // Send the captured image to Flask server
            fetch('/upload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ image: imageData })
            })
            .then(response => response.json())
            .then(data => {
                var resultDiv = document.getElementById('result');
                resultDiv.innerHTML = ''; // Clear previous results
                if (data.error) {
                    resultDiv.innerText = 'Error: ' + data.error;
                } else {
                    // Generate the product card and display it in the resultDiv
                    resultDiv.innerHTML = generateProductCard(data);

                    // Add the product to the cart
                    addToCart(data);
                }
            })
            .catch(error => {
                var resultDiv = document.getElementById('result');
                resultDiv.innerText = 'Error: ' + error.message;
            });
        }

        // ... (Existing code for addToCart, generateProductCard, and navigateToPayment functions)
	function addToCart(data) {
            var cartItems = document.getElementById('cart-items');
            var listItem = document.createElement('li');
    
            // Generate the product card and append it to the cartItems
            listItem.innerHTML = generateProductCard(data);
            cartItems.appendChild(listItem);
        }
    
        // Function to generate the HTML structure for the product card
        function generateProductCard(data) {
            var name = data['Product Name'];
            var price = data['Price'];
            var id = data['Product ID'];
            var imageURL = '/static/images/' + name + '.jpg'
            return `
                <div class="card1">
                    <div class="card-content">
                        <div class="card-image">
                            <img src="${imageURL}" alt="${name}" style="width: 100px; height: 100px; margin-top: 25px">
                        </div>
                        
                        <div class="card-info">
                            <p><strong>Product Name:</strong> ${name}</p>
                            <p><strong>Price:</strong> ${price}</p>
                            <p><strong>Product ID:</strong> ${id}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        function navigateToPayment() {
            // Fetch the items in the cart from the server
            fetch('/get_cart_items')
                .then(response => response.json())
                .then(data => {
                    var cartItems = data['cart_items'];
        
                    // Remove dollar signs and spaces from item prices
                    cartItems.forEach(item => {
                        item['Price'] = parseFloat(item['Price'].replace('$', '').trim());
                    });
        
                    var totalAmount = cartItems.reduce((total, item) => total + item['Price'], 0);
        
                    // Redirect to the payment page with cart items and total amount as parameters
                    var paymentUrl = `/payment?cartItems=${JSON.stringify(cartItems)}&totalAmount=${totalAmount}`;
                    window.location.href = paymentUrl;
                })
                .catch(error => {
                    console.error('Error fetching cart items:', error);
                });
        }
        
    </script>
</body>
</html>